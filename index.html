<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... Meta y estilo mantenidos igual ... -->
</head>
<body>
    <!-- ... Contenido HTML mantenido igual ... -->

    <script>
        const levels = ["Bronce", "Plata", "Oro", "Diamante", "Maestro"];
        let users = JSON.parse(localStorage.getItem("users")) || {};
        let currentUser = null;

        function login() {
            const username = document.getElementById("username").value.trim();
            if (!username) {
                document.getElementById("login-feedback").textContent = "Por favor, ingresa un nombre de usuario.";
                return;
            }

            if (!users[username]) {
                users[username] = { levelIndex: 0, progress: [], attempts: Array(levels.length).fill(0) };
            }
            currentUser = username;
            document.getElementById("player-name").textContent = currentUser;

            const levelIndex = users[currentUser].levelIndex;
            if (levelIndex === levels.length - 1) {
                switchToCongratulations();
            } else {
                updateGameView();
                switchView("game-container");
            }

            loadAdminView(); // Actualizar vista de administrador tras iniciar sesión
        }

        function updateGameView() {
            const levelIndex = users[currentUser].levelIndex;
            document.getElementById("current-level").textContent = levels[levelIndex];
            document.getElementById("attempt-count").textContent = users[currentUser].attempts[levelIndex];
            generateEquation(levelIndex);
        }

        function generateEquation(levelIndex) {
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 20) - 10;
            const x = Math.floor(Math.random() * 10);
            const c = a * x + b;

            const formattedB = b >= 0 ? `+ ${b}` : `- ${Math.abs(b)}`;
            document.getElementById("equation").textContent = `${a}x ${formattedB} = ${c}`;
            document.getElementById("equation").dataset.answer = x;
        }

        function checkAnswer() {
            const answer = parseInt(document.getElementById("answer").value);
            const correctAnswer = parseInt(document.getElementById("equation").dataset.answer);

            if (answer === correctAnswer) {
                advanceLevel();
            } else {
                users[currentUser].attempts[users[currentUser].levelIndex]++;
                localStorage.setItem("users", JSON.stringify(users));
                document.getElementById("attempt-count").textContent = users[currentUser].attempts[users[currentUser].levelIndex];
                document.getElementById("game-feedback").textContent = "Respuesta incorrecta. Intenta de nuevo.";
                loadAdminView(); // Actualizar vista de administrador tras cada intento
            }
        }

        function advanceLevel() {
            const levelIndex = users[currentUser].levelIndex;
            if (levelIndex < levels.length - 1) {
                users[currentUser].levelIndex++;
                users[currentUser].progress[levelIndex] = new Date().toLocaleString();
                localStorage.setItem("users", JSON.stringify(users));
                updateGameView();
                document.getElementById("game-feedback").textContent = "¡Nivel completado! Avanzas al siguiente.";
            } else {
                users[currentUser].progress[levelIndex] = new Date().toLocaleString();
                localStorage.setItem("users", JSON.stringify(users));
                switchToCongratulations();
            }
            loadAdminView(); // Actualizar vista de administrador tras avanzar de nivel
        }

        function switchToCongratulations() {
            document.getElementById("winner-name").textContent = currentUser;
            switchView("congratulations-container");
            loadAdminView(); // Actualizar vista de administrador al alcanzar el nivel Maestro
        }

        function logout() {
            currentUser = null;
            switchView("login-container");
        }

        function requestAdminAccess() {
            const password = prompt("Introduce la contraseña de administrador:");
            if (password === "admin123") {
                switchView("admin-container");
                loadAdminView(); // Asegurar que la vista se actualice al acceder
            } else {
                alert("Contraseña incorrecta.");
            }
        }

        function loadAdminView() {
            const records = document.getElementById("user-records");
            records.innerHTML = "";
            for (const [username, data] of Object.entries(users)) {
                const totalAttempts = data.attempts.reduce((sum, attempts) => sum + attempts, 0);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${username}</td>
                    ${levels.map((_, i) => `<td>${data.progress[i] || "-"}</td>`).join("")}
                    <td>${totalAttempts}</td>
                    <td><button onclick="deleteUser('${username}')">Eliminar</button></td>
                `;
                records.appendChild(row);
            }
        }

        function deleteUser(username) {
            if (confirm(`¿Estás seguro de que deseas eliminar a ${username}?`)) {
                delete users[username];
                localStorage.setItem("users", JSON.stringify(users));
                loadAdminView(); // Actualizar vista de administrador tras eliminar usuario
            }
        }

        function downloadRecords() {
            const rows = ["Username,Bronce,Plata,Oro,Diamante,Maestro,Intentos Totales"];
            for (const [username, data] of Object.entries(users)) {
                const totalAttempts = data.attempts.reduce((sum, attempts) => sum + attempts, 0);
                const row = [username, ...levels.map((_, i) => data.progress[i] || "-"), totalAttempts];
                rows.push(row.join(","));
            }
            const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "registro_usuarios.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function logoutAdmin() {
            switchView("login-container");
        }

        function switchView(containerId) {
            document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
            document.getElementById(containerId).classList.remove("hidden");
        }
    </script>
</body>
</html>
